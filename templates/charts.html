{% extends 'base.html' %}
{% block title %}–î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8 space-y-8">

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
    <h1 class="text-3xl font-bold text-white">üìä –î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞</h1>

    <div class="flex items-center gap-3">
      <label for="projectSelect" class="text-white text-sm font-medium">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç:</label>
      <select id="projectSelect"
              class="bg-slate-800 text-white border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300">
        {% for project in projects %}
          <option value="{{ project.id }}">{{ project.name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
  <div id="loading-indicator" class="hidden flex justify-center items-center py-10">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-gray-400"></div>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–∏–∞–≥—Ä–∞–º–º—ã -->
  <div id="gantt-container"
       class="rounded-xl bg-slate-900 border border-slate-700 shadow-xl p-4 overflow-x-auto transition-all duration-300"
       style="min-height: 500px;"></div>
       
  <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
  <div class="flex flex-wrap gap-4 justify-center mt-4">
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded bg-red-600"></div>
      <span class="text-sm text-gray-300">–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded bg-amber-500"></div>
      <span class="text-sm text-gray-300">–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded bg-green-600"></div>
      <span class="text-sm text-gray-300">–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded bg-blue-500"></div>
      <span class="text-sm text-gray-300">–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞</span>
    </div>
  </div>
</div>

<!-- vis.js timeline -->
<link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" />
<script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("gantt-container");
    const select = document.getElementById("projectSelect");
    const loadingIndicator = document.getElementById("loading-indicator");
    let timeline = null;

    function showLoading() {
      loadingIndicator.classList.remove('hidden');
      container.classList.add('opacity-50');
    }

    function hideLoading() {
      loadingIndicator.classList.add('hidden');
      container.classList.remove('opacity-50');
    }

    function renderGantt(data) {
      const items = new vis.DataSet();
      const groups = new vis.DataSet();

      data.forEach((t, index) => {
        groups.add({ 
          id: index, 
          content: `<div class="text-sm text-gray-400 py-1">${t.name}</div>` 
        });

        items.add({
          id: t.id,
          content: `<div class="gantt-item-content">
                      <div class="gantt-item-title">${t.name}</div>
                    </div>`,
          start: t.start,
          end: t.end,
          group: index,
          className: `priority-${(t.priority || '').toLowerCase()}`,
          title: `
            <div class="gantt-tooltip">
              <div class="gantt-tooltip-title">${t.name}</div>
              <div class="gantt-tooltip-dates">üìÖ ${t.start} ‚Üí ${t.end}</div>
              <div class="gantt-tooltip-desc">üìù ${t.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
              <div class="gantt-tooltip-priority">üî• –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${t.priority}</div>
            </div>`,
          url: `/task/${t.id}`
        });
      });

      const options = {
        stack: false,
        showCurrentTime: true,
        showMajorLabels: true,
        showMinorLabels: true,
        zoomable: true,
        moveable: true,
        editable: false,
        orientation: 'top',
        margin: { item: 20, axis: 40 },
        start: new Date(new Date().setDate(new Date().getDate() - 5)),
        end: new Date(new Date().setDate(new Date().getDate() + 30)),
        timeAxis: { scale: 'day', step: 1 },
        format: {
          minorLabels: {
            day: 'D',
            hour: 'HH:mm'
          },
          majorLabels: {
            day: 'D MMMM YYYY'
          }
        },
        template: function(item) {
          return item.content;
        },
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
        zoomMin: 1000 * 60 * 60 * 24,  // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± - 1 –¥–µ–Ω—å
        zoomMax: 1000 * 60 * 60 * 24 * 31 * 3, // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–± - 3 –º–µ—Å—è—Ü–∞
        throttleRedraw: 16, // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ (60 FPS)
        rollingMode: {
          follow: false // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
        }
      };

      if (timeline) timeline.destroy();
      timeline = new vis.Timeline(container, items, groups, options);

      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
      container.style.opacity = 0;
      setTimeout(() => {
        container.style.opacity = 1;
      }, 100);

      // –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ –∫–ª–∏–∫—É
      timeline.on("select", function (props) {
        const item = items.get(props.items[0]);
        if (item && item.url) {
          // –ê–Ω–∏–º–∞—Ü–∏—è –∫–ª–∏–∫–∞
          const clickEffect = document.createElement('div');
          clickEffect.className = 'click-effect';
          clickEffect.style.left = props.event.clientX + 'px';
          clickEffect.style.top = props.event.clientY + 'px';
          document.body.appendChild(clickEffect);
          
          setTimeout(() => {
            clickEffect.remove();
            window.location.href = item.url;
          }, 300);
        }
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—ë—Ä–≥–∞–Ω–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
      container.addEventListener('mousemove', function(e) {
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–∏—à–Ω–∏—Ö –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–æ–∫
        e.stopPropagation();
      }, { passive: true });
      
      // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
      let scrollTimeout;
      container.addEventListener('scroll', function() {
        if (!scrollTimeout) {
          scrollTimeout = setTimeout(function() {
            scrollTimeout = null;
          }, 16); // ~60fps
        }
      }, { passive: true });
    }

    async function loadGantt(projectId) {
      try {
        showLoading();
        const res = await fetch(`/charts/api/project/${projectId}/gantt`);
        const data = await res.json();
        hideLoading();
        renderGantt(data);
      } catch (err) {
        hideLoading();
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã:", err);
        container.innerHTML = `
          <div class="flex flex-col items-center justify-center h-full py-10">
            <div class="text-red-500 text-xl mb-2">
              <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="text-gray-400 text-center">
              –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã.<br>
              –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.
            </div>
          </div>
        `;
      }
    }

    select.addEventListener("change", () => {
      const projectId = select.value;
      loadGantt(projectId);
    });
    
    loadGantt(select.value);
  });
</script>

<style>
  /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã */
  .vis-timeline {
    border: none !important;
    font-family: 'Inter', sans-serif;
    background-color: transparent !important;
    /* –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–≤–Ω–æ—Å—Ç—å –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ */
    will-change: transform;
    backface-visibility: hidden;
  }
  
  .vis-panel.vis-center,
  .vis-panel.vis-left,
  .vis-panel.vis-right,
  .vis-panel.vis-top,
  .vis-panel.vis-bottom {
    border-color: #334155 !important;
  }
  
  .vis-grid.vis-vertical,
  .vis-grid.vis-horizontal {
    border-color: rgba(51, 65, 85, 0.5) !important;
  }
  
  .vis-time-axis .vis-text {
    color: #94a3b8 !important;
    font-size: 0.85rem;
  }
  
  .vis-time-axis .vis-grid.vis-minor {
    border-color: rgba(51, 65, 85, 0.3) !important;
  }
  
  .vis-time-axis .vis-grid.vis-major {
    border-color: rgba(51, 65, 85, 0.7) !important;
  }
  
  /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–∏–∞–≥—Ä–∞–º–º—ã */
  .vis-item {
    border-radius: 4px !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    /* –£–±–∏—Ä–∞–µ–º –¥—ë—Ä–≥–∞–Ω–∏–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    transition: box-shadow 0.2s ease !important;
    /* –î–æ–±–∞–≤–ª—è–µ–º –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ */
    transform: translateZ(0);
    will-change: box-shadow;
  }
  
  .vis-item:hover {
    /* –£–±–∏—Ä–∞–µ–º transform –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—ë—Ä–≥–∞–Ω–∏—è */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
    z-index: 10 !important;
  }
  
  .vis-item.vis-selected {
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5) !important;
  }
  
  /* –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞–¥–∞—á */
  .vis-item.priority-–≤—ã—Å–æ–∫–∏–π {
    background-color: rgba(220, 38, 38, 0.8) !important;
    border-color: #ef4444 !important;
  }
  
  .vis-item.priority-—Å—Ä–µ–¥–Ω–∏–π {
    background-color: rgba(245, 158, 11, 0.8) !important;
    border-color: #fbbf24 !important;
  }
  
  .vis-item.priority-–Ω–∏–∑–∫–∏–π {
    background-color: rgba(22, 163, 74, 0.8) !important;
    border-color: #22c55e !important;
  }
  
  /* –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
  .vis-item .vis-item-content {
    color: white !important;
    font-weight: 500 !important;
    padding: 4px 8px !important;
  }
  
  .gantt-item-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  
  .gantt-item-title {
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ */
  .vis-current-time {
    background-color: #3b82f6 !important;
    width: 2px !important;
  }
  
  /* –¢—É–ª—Ç–∏–ø—ã */
  .vis-tooltip {
    background-color: #1e293b !important;
    border: 1px solid #334155 !important;
    border-radius: 6px !important;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
    color: #f8fafc !important;
    font-family: 'Inter', sans-serif !important;
    padding: 8px 12px !important;
    /* –§–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ç—É–ª—Ç–∏–ø–∞ */
    pointer-events: none;
  }
  
  .gantt-tooltip-title {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 6px;
    color: white;
  }
  
  .gantt-tooltip-dates,
  .gantt-tooltip-desc,
  .gantt-tooltip-priority {
    font-size: 0.875rem;
    margin-bottom: 4px;
    color: #cbd5e1;
  }
  
  /* –≠—Ñ—Ñ–µ–∫—Ç –∫–ª–∏–∫–∞ */
  .click-effect {
    position: fixed;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: rgba(59, 130, 246, 0.3);
    transform: translate(-50%, -50%);
    pointer-events: none;
    animation: click-animation 0.3s ease-out forwards;
    z-index: 9999;
  }
  
  @keyframes click-animation {
    0% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(0);
    }
    100% {
      opacity: 0;
      transform: translate(-50%, -50%) scale(2);
    }
  }
  
  /* –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ */
  .vis-timeline,
  .vis-panel,
  .vis-labelset,
  .vis-foreground,
  .vis-group {
    transform: translateZ(0);
    backface-visibility: hidden;
    perspective: 1000px;
  }
</style>

{% endblock %}
