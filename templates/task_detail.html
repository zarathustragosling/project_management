{% extends 'base.html' %}
{% block title %}–ó–∞–¥–∞—á–∞: {{ task.title }}{% endblock %}

{% block content %}
<div class="container space-y-6">
  <div class="space-y-2">
    <h1 class="text-3xl font-bold">{{ task.title }}</h1>
    <p class="text-gray-400">{{ task.description or "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è" }}</p>

    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
      <p><strong>–ü—Ä–æ–µ–∫—Ç:</strong> <a href="{{ url_for('project_detail', project_id=task.project.id) }}" class="text-blue-400 hover:underline">{{ task.project.name }}</a></p>
      <p><strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong> {{ task.priority }}</p>
      <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ task.status.value }}</p>
      <p><strong>–°–æ–∑–¥–∞–Ω–æ:</strong> {{ task.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
      <p><strong>–î–µ–¥–ª–∞–π–Ω:</strong> {{ task.deadline.strftime('%d.%m.%Y') if task.deadline else "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" }}</p>
      <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> {{ task.assigned_user.username if task.assigned_user else "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω" }}</p>
      <p><strong>–ü–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫:</strong> {{ task.creator.username }}</p>
    </div>

    {% if current_user.id == task.created_by %}
    <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn mt-4">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
    {% endif %}
  </div>

  <hr class="my-6">
  <h2 class="text-xl font-semibold mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>

  <div id="comments-list" class="space-y-4">
    {% for comment in task.comments if not comment.parent_id %}
    <div class="flex items-start gap-3" data-comment-id="{{ comment.id }}">
      <img src="{{ comment.author.avatar or url_for('static', filename='default_avatar.png') }}" class="w-8 h-8 rounded-full object-cover" alt="avatar">
      <div class="w-full bg-gray-800 p-4 rounded-lg">
        <div class="flex items-center gap-2">
          <a href="{{ url_for('user_profile', user_id=comment.author.id) }}" class="font-semibold text-white text-sm hover:underline">
            {{ comment.author.username }}
          </a>
          <span class="text-xs text-gray-400">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
        </div>

        <p class="mt-2 text-white text-sm">{{ comment.content|highlight_mentions }}</p>

        {% if comment.attachments %}
        <div class="mt-2 space-y-1">
          {% for attachment in comment.attachments %}
          <a href="{{ url_for('static', filename=attachment.filepath) }}" class="text-blue-400 hover:underline text-sm block">üìé {{ attachment.filename }}</a>
          {% endfor %}
        </div>
        {% endif %}

        <button type="button"
                class="reply-btn text-xs text-blue-400 mt-2"
                data-username="{{ comment.author.username }}"
                data-userid="{{ comment.author.id }}"
                data-commentid="{{ comment.id }}">
          –û—Ç–≤–µ—Ç–∏—Ç—å
        </button>

        {% if comment.replies %}
        <button type="button" class="toggle-thread text-xs text-gray-400 ml-2">–°–≤–µ—Ä–Ω—É—Ç—å –≤–µ—Ç–∫—É</button>
        <div class="ml-6 mt-4 space-y-4 thread-block">
          {% for reply in comment.replies %}
          <div class="flex items-start gap-3">
            <img src="{{ reply.author.avatar or url_for('static', filename='default_avatar.png') }}" class="w-8 h-8 rounded-full object-cover" alt="avatar">
            <div class="w-full bg-gray-700 p-3 rounded-lg">
              <div class="flex items-center gap-2">
                <a href="{{ url_for('user_profile', user_id=reply.author.id) }}" class="font-semibold text-white text-sm hover:underline">
                  {{ reply.author.username }}
                </a>
                <span class="text-xs text-gray-300">{{ reply.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
              </div>
              <div class="text-xs text-blue-300 mb-1">–û—Ç–≤–µ—Ç –Ω–∞ <a href="{{ url_for('user_profile', user_id=comment.author.id) }}" class="hover:underline">@{{ comment.author.username }}</a></div>
              <p class="mt-1 text-white text-sm">{{ reply.content|highlight_mentions }}</p>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  <h3 class="text-lg font-medium mt-8">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
  <form id="commentForm" method="POST"
        action="{{ url_for('add_comment', task_id=task.id) }}"
        enctype="multipart/form-data"
        class="space-y-4 mt-4">
    <input type="hidden" name="parent_id" id="parent_id" value="">
    <textarea name="content" id="commentContent" rows="3" required
              class="w-full p-2 rounded bg-gray-800 text-white border border-gray-600"
              placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
    <input type="file" name="attachment" class="block text-white" />
    <button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>
</div>


{% endblock %}
