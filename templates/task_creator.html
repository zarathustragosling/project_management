{% extends 'base.html' %}
{% block title %}{{ '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É' if is_edit else '–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É' }}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 py-10">
  <h1 class="text-3xl font-bold text-white mb-6">
    {{ '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É' if is_edit else 'üÜï –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏' }}
  </h1>

  <form method="POST"
        action="{{ url_for('task_blueprint.edit_task', task_id=task.id) if is_edit else url_for('task_blueprint.task_creator') }}"
        class="space-y-6 bg-zinc-700 p-6 rounded-xl shadow" enctype="multipart/form-data">

    <div>
      <label for="title" class="block text-sm font-medium text-white mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input type="text" name="title" id="title" required
             value="{{ task.title if is_edit else '' }}"
             class="w-full p-3 rounded-lg bg-zinc-900 text-white border border-gray-700 focus:border-white-500 focus:outline-none">
    </div>

    <div>
      <label for="description" class="block text-sm font-medium text-white mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
      <textarea name="description" id="description" rows="4"
                class="w-full p-3 rounded-lg bg-zinc-900 text-white border border-gray-700 focus:border-white-500">{{ task.description if is_edit else '' }}</textarea>
    </div>

    <div>
      <label for="priority" class="block text-sm font-medium text-white mb-1">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
      <select name="priority" id="priority"
              class="w-full p-3 rounded-lg bg-zinc-900 text-white border border-gray-700">
        {% for p in ['–í—ã—Å–æ–∫–∏–π', '–°—Ä–µ–¥–Ω–∏–π', '–ù–∏–∑–∫–∏–π'] %}
          <option value="{{ p }}" {% if is_edit and task.priority == p %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
    </div>

    

    {% if not is_edit %}
    <div>
      <label for="project_id" class="block text-sm font-medium text-white mb-1">–ü—Ä–æ–µ–∫—Ç</label>
      <select name="project_id" id="project_id" required
              class="w-full p-3 rounded-lg bg-zinc-900 text-white border border-gray-700">
        {% for project in team_projects %}
          <option value="{{ project.id }}">{{ project.name }}</option>
        {% endfor %}
      </select>
    </div>
    {% else %}
    <div>
      <label class="block text-sm font-medium text-white mb-1">–ü—Ä–æ–µ–∫—Ç</label>
      <p class="p-3 rounded-lg bg-zinc-900 text-white border border-gray-700">
        {{ task.project.name }}
      </p>
    </div>
    {% endif %}

    <div>
      <label for="assigned_to" class="block text-sm font-medium text-white mb-1">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
      <select name="assigned_to" id="assigned_to"
              class="w-full p-3 rounded-lg bg-zinc-900 text-white border border-gray-700">
        <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
        {% for user in users %}
          <option value="{{ user.id }}" {% if is_edit and task.assigned_to == user.id %}selected{% endif %}>
            {{ user.username }}
          </option>
        {% endfor %}
      </select>
    </div>


    <div>
      <label for="created_at" class="block text-sm font-medium text-white mb-1">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</label>
      <input type="date" name="created_at" id="created_at"
             value="{% if is_edit and task.created_at %}{{ task.created_at.strftime('%Y-%m-%d') }}{% else %}{{ current_date }}{% endif %}"
             class="w-full p-3 rounded-lg bg-zinc-900 text-white border border-gray-700">
    </div>
    

    <div>
      <label for="deadline" class="block text-sm font-medium text-white mb-1">–î–µ–¥–ª–∞–π–Ω</label>
      <input type="date" name="deadline" id="deadline"
       value="{% if is_edit and task.deadline %}{{ task.deadline.strftime('%Y-%m-%d') }}{% else %}{{ next_date }}{% endif %}"
       min="{{ next_date }}"
       class="w-full p-3 rounded-lg bg-zinc-900 text-white border border-gray-700">


    </div>

  

    <div class="pt-4">
      <button type="submit"
              class="bg-zinc-500 hover:bg-zinc-900 text-white px-6 py-3 rounded-lg font-medium text-sm transition">
        {{ 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' if is_edit else '‚úÖ –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É' }}
      </button>
    </div>
  </form>
</div>

<script>
  const assignedSelect = document.getElementById("assigned_to");
  document.getElementById("project_id")?.addEventListener("change", () => {
    const pid = project_id.value;
    assignedSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
    fetch(`/get_project_users/${pid}`)
      .then(res => res.json())
      .then(users => {
        assignedSelect.innerHTML = '<option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>';
        users.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = u.username;
          assignedSelect.appendChild(opt);
        });
      });
  });

  const createdAtInput = document.getElementById("created_at");
  const deadlineInput = document.getElementById("deadline");

  function updateDeadlineMin() {
    const createdDate = new Date(createdAtInput.value);
    if (isNaN(createdDate.getTime())) return;

    // –î–æ–±–∞–≤–ª—è–µ–º 1 –¥–µ–Ω—å
    const minDeadlineDate = new Date(createdDate);
    minDeadlineDate.setDate(minDeadlineDate.getDate() + 1);

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ YYYY-MM-DD
    const yyyy = minDeadlineDate.getFullYear();
    const mm = String(minDeadlineDate.getMonth() + 1).padStart(2, '0');
    const dd = String(minDeadlineDate.getDate()).padStart(2, '0');
    const minDateStr = `${yyyy}-${mm}-${dd}`;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –∑–Ω–∞—á–µ–Ω–∏–µ
    deadlineInput.min = minDateStr;

    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –¥–µ–¥–ª–∞–π–Ω –ø—É—Å—Ç–æ–π –∏–ª–∏ —Ä–∞–Ω—å—à–µ min ‚Äî —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ –≤ min
    if (!deadlineInput.value || deadlineInput.value < minDateStr) {
      deadlineInput.value = minDateStr;
    }
  }

  // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è
  window.addEventListener("load", updateDeadlineMin);
  createdAtInput.addEventListener("change", updateDeadlineMin);
</script>
{% endblock %}
